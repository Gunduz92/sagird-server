<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <title>TapÅŸÄ±rÄ±q Yoxlama Sistemi</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">
    <h1>ğŸš€ TapÅŸÄ±rÄ±q Yoxlama Sistemi</h1>

    <!-- Kateqoriya seÃ§imi -->
    <div class="task-select">
        <label for="categorySelect">Kateqoriya seÃ§in:</label><br>
        <select id="categorySelect" onchange="filterTasks()">
            <option value="">-- SeÃ§in --</option>
            {% for category in categories %}
                <option value="{{ category }}">{{ category.capitalize() }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- TapÅŸÄ±rÄ±q seÃ§imi -->
    <div class="task-select">
        <label for="taskSelect">TapÅŸÄ±rÄ±q seÃ§in:</label><br>
        <select id="taskSelect" onchange="loadTask()">
            <!-- TapÅŸÄ±rÄ±qlar buraya avtomatik gÉ™lÉ™cÉ™k -->
        </select>
    </div>

    <!-- TapÅŸÄ±rÄ±q mÉ™tnini gÃ¶stÉ™r -->
    <div class="task-card">
        <h2>TapÅŸÄ±rÄ±q:</h2>
        <div id="taskText">TapÅŸÄ±rÄ±q seÃ§in...</div>
    </div>

    <!-- Kod yazmaq Ã¼Ã§Ã¼n sahÉ™ -->
    <h2>Kodunuzu yazÄ±n:</h2>
    <textarea id="code" placeholder="# Buraya kodunuzu yazÄ±n..." rows="20"></textarea>

    <br><br>
    <button onclick="submitCode()" class="btn">âœ… Yoxla</button>

    <h2>Test NÉ™ticÉ™lÉ™ri:</h2>
    <ul id="result" class="result-list"></ul>

    <!-- Progress bar -->
    <div id="progressContainer" class="progress-container" style="display:none;">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
</div>

<script>
let allTasks = {{ tasks|tojson }};
let filteredTasks = [];

function filterTasks() {
    const selectedCategory = document.getElementById('categorySelect').value;
    const taskSelect = document.getElementById('taskSelect');
    taskSelect.innerHTML = '';

    filteredTasks = allTasks.filter(task => task.category === selectedCategory);

    filteredTasks.forEach((task, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = task.description.slice(0, 50) + '...';
        taskSelect.appendChild(option);
    });

    // Task seÃ§ilÉ™ndÉ™ dÉ™rhal ilk tapÅŸÄ±rÄ±ÄŸÄ± gÃ¶stÉ™r
    loadTask();
}

function loadTask() {
    const taskId = document.getElementById('taskSelect').value;
    if (taskId !== '') {
        document.getElementById('taskText').innerText = filteredTasks[taskId].description;
    }
}

function submitCode() {
    const code = document.getElementById('code').value;
    const taskId = document.getElementById('taskSelect').value;

    if (taskId === '') {
        alert("ZÉ™hmÉ™t olmasa bir tapÅŸÄ±rÄ±q seÃ§in!");
        return;
    }

    fetch('/check', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({code: code, task_id: taskId})
    })
    .then(response => response.json())
    .then(data => {
        const resultElement = document.getElementById('result');
        resultElement.innerHTML = '';

        let dogru = 0;
        let cem = data.results.length;

        data.results.forEach((res, idx) => {
            const li = document.createElement('li');
            li.className = res.correct ? 'success' : 'fail';
            li.innerHTML = `Test ${idx+1}: ${res.correct ? 'âœ… DoÄŸru' : 'âŒ YanlÄ±ÅŸ'}`;

            if (!res.correct) {
                const hintButton = document.createElement('button');
                hintButton.innerText = 'ğŸ’¡ Ä°pucu istÉ™yirÉ™m';
                hintButton.style.marginLeft = "10px";
                hintButton.onclick = function() {
                    fetch('/hint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            expected_output: res.expected_output,
                            user_output: res.user_output,
                            error_message: res.error_message || '',
                            code: res.code
                        })
                    })
                    .then(response => response.json())
                    .then(hintData => {
                        alert(`ğŸ’¡ Ä°pucu: ${hintData.hint}`);
                    });
                };
                li.appendChild(hintButton);
            }

            if (res.correct) dogru++;
            resultElement.appendChild(li);
        });

        // Proqres barÄ± gÃ¼ncÉ™llÉ™
        const faiz = Math.round((dogru / cem) * 100);
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');

        progressContainer.style.display = 'block';
        progressBar.style.width = faiz + '%';
        progressBar.innerText = faiz + '%';
        progressBar.style.backgroundColor = faiz === 100 ? 'green' : (faiz >= 50 ? 'orange' : 'red');
    })
    .catch(error => {
        alert("XÉ™ta baÅŸ verdi: " + error);
    });
}
</script>

</body>
</html>
